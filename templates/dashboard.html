{% extends "base.html" %}

{% block title %}Dashboard - MYBILLS{% endblock %}

{% block content %}
<!-- Success message -->
{% if request.query_params.get('success') == 'transaction_added' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> ¡Transacción agregada exitosamente!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Error message -->
{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- View Toggle Controls -->
<div class="row mb-3">
    <div class="col-md-6">
        <h1 class="h3 mb-0">
            <i class="bi bi-speedometer2"></i> 
            Dashboard
        </h1>
        <p class="text-muted">
            {% if is_monthly %}
                Resumen de transacciones {{ get_current_month_name() }}
            {% else %}
                Todas tus transacciones
            {% endif %}
        </p>
    </div>
    <div class="col-md-6 text-end">
        <div class="btn-group" role="group" aria-label="Vista">
            <input type="radio" class="btn-check" name="viewOptions" id="monthlyView" autocomplete="off" 
                   {% if is_monthly %}checked{% endif %} onchange="changeView('monthly')">
            <label class="btn btn-outline-primary" for="monthlyView" 
                   data-bs-toggle="tooltip" data-bs-placement="bottom" title="Presiona 'M' para cambio rápido">
                <i class="bi bi-calendar-month"></i> {{ get_current_month_name() }}
            </label>
            
            <input type="radio" class="btn-check" name="viewOptions" id="historicalView" autocomplete="off" 
                   {% if not is_monthly %}checked{% endif %} onchange="changeView('historical')">
            <label class="btn btn-outline-primary" for="historicalView"
                   data-bs-toggle="tooltip" data-bs-placement="bottom" title="Presiona 'H' para cambio rápido">
                <i class="bi bi-clock-history"></i> Histórico
            </label>
        </div>
        
        <a href="/add-transaction" class="btn btn-success ms-2"
           data-bs-toggle="tooltip" data-bs-placement="bottom" title="Presiona 'N' para acceso rápido">
            <i class="bi bi-plus-circle"></i> Nueva Transacción
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4 mt-4">
    <div class="col-md-3 mb-3">
        <div class="card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-success mb-1">
                            Ingresos 
                        </h6>
                        <h4 class="mb-0">{{ format_currency(summary.total_ingresos) }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-up-circle text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card border-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-danger mb-1">
                            Gastos 
                        </h6>
                        <h4 class="mb-0">{{ format_currency(summary.total_gastos) }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-down-circle text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card border-{% if summary.balance >= 0 %}success{% else %}danger{% endif %}">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-{% if summary.balance >= 0 %}success{% else %}danger{% endif %} mb-1">
                            Balance 
                        </h6>
                        <h4 class="mb-0">{{ format_currency(summary.balance) }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-{% if summary.balance >= 0 %}graph-up{% else %}graph-down{% endif %} text-{% if summary.balance >= 0 %}success{% else %}danger{% endif %}" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Transactions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul"></i> Transacciones Recientes
        </h5>
        <span class="badge bg-secondary">{{ summary.count_transactions }} total</span>
    </div>
    <div class="card-body p-0">
        {% if transactions %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Origen</th>
                        <th class="text-end">Monto</th>
                        <th width="100">Acciones</th>
                    </tr>
                </thead>
                <tbody>
{% for transaction in transactions %}
<tr class="{% if not transaction.validated %}table-warning{% endif %}">
    <td>
        <small class="text-muted">
            {{ format_datetime(transaction.date) }}
        </small>
    </td>
    <td>
        <span class="badge bg-{% if transaction.type == 'ingreso' %}success{% elif transaction.type == 'gasto' %}danger{% else %}info{% endif %}">
            {{ get_transaction_type_icon(transaction.type) }} {{ humanize_transaction_type(transaction.type) }}
            {% if not transaction.validated %}
                <i class="bi bi-exclamation-circle text-warning" title="No validado"></i>
            {% endif %}
        </span>
    </td>
    <td>
        {% if transaction.description %}
            {{ transaction.description[:50] }}{% if transaction.description|length > 50 %}...{% endif %}
        {% else %}
            <span class="text-muted">Sin descripción</span>
        {% endif %}
    </td>
    <td>
        {% if transaction.category %}
            <span class="badge bg-light text-dark">{{ humanize_category(transaction.category) }}</span>
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td>
        <small class="text-muted">
            {{ humanize_origin(transaction.origin) }}
        </small>
    </td>
    <td class="text-end">
        <strong class="{{ get_transaction_type_color(transaction.type) }}">
            {{ format_currency(transaction.amount) }}
        </strong>
    </td>
<td>
    <div class="d-flex gap-1">
        <a href="/transaction/{{ transaction._id }}" class="btn btn-sm btn-outline-primary" title="Ver detalles">
            <i class="bi bi-eye"></i>
        </a>
        {% if not transaction.validated %}
            <!-- Botón para validar -->
            <form method="post" action="/validate-transaction/{{ transaction._id }}">
                <button type="submit" class="btn btn-sm btn-success" title="Validar gasto">
                    <i class="bi bi-check-circle"></i>
                </button>
            </form>


<div class="modal fade" id="confirmDeleteModal-{{ transaction._id }}" tabindex="-1" aria-labelledby="confirmDeleteLabel-{{ transaction._id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel-{{ transaction._id }}">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro que deseas eliminar este gasto?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="document.querySelector('#deleteForm-{{ transaction._id }}').submit();">Eliminar</button>
      </div>
    </div>
  </div>
</div>
            <!-- Botón para borrar -->
<form method="post" action="/delete-transaction/{{ transaction._id }}" id="deleteForm-{{ transaction._id }}">
    <button type="button" class="btn btn-sm btn-danger" title="Eliminar gasto" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal-{{ transaction._id }}">
        <i class="bi bi-trash"></i>
    </button>
</form>
        {% endif %}
    </div>
</td>
</tr>
{% endfor %}

                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="card-footer">
            <nav aria-label="Paginación de transacciones">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ pagination.prev_num or 1 }}&view={{ current_view }}">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </a>
                    </li>
                    
                    {% for page_num in range(1, pagination.pages + 1) %}
                        {% if page_num == pagination.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_num }}&view={{ current_view }}">{{ page_num }}</a>
                            </li>
                        {% elif page_num == 4 or page_num == pagination.pages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ pagination.next_num or pagination.pages }}&view={{ current_view }}">
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <h5 class="text-muted mt-3">No hay transacciones</h5>
            <p class="text-muted">Comienza agregando tu primera transacción</p>
            <a href="/add-transaction" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Agregar Transacción
            </a>
        </div>
        {% endif %}


   <div class="col-auto m-2 text-center">
        <a href="/add-transaction" class="btn btn-outline-secondary">
            <i class="bi bi-plus-circle"></i> Nueva Transacción
        </a>
    </div>
    </div>

</div>

<!-- Charts Section -->
{% if chart_data.categories|length > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i> Distribución de Gastos por Categoría
                    {% if is_monthly %}
                        <small class="text-muted">({{ get_current_month_name() }})</small>
                    {% else %}
                        <small class="text-muted">(Histórico)</small>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h6 class="text-muted mb-3">Desglose por Categoría</h6>
                        <div id="categoryLegend" class="list-group list-group-flush">
                            <!-- La leyenda se generará con JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
{% if transactions|length > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i> Distribución de Gastos por Categoría
                </h5>
            </div>
            <div class="card-body text-center py-5">
                <i class="bi bi-pie-chart text-muted" style="font-size: 4rem;"></i>
                <h5 class="text-muted mt-3">No hay gastos para mostrar</h5>
                <p class="text-muted">
                    {% if is_monthly %}
                        No tienes gastos registrados en {{ get_current_month_name() }}
                    {% else %}
                        No tienes gastos registrados
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-refresh page every 5 minutes
    setTimeout(function() {
        window.location.reload();
    }, 300000);
});

function changeView(viewType) {
    // Construir URL con el nuevo parámetro de vista
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('view', viewType);
    urlParams.delete('page'); // Reset pagination when changing view
    
    // Redirigir a la nueva URL
    window.location.href = '/dashboard?' + urlParams.toString();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // M for monthly view
    if (e.key === 'm' || e.key === 'M') {
        if (!e.ctrlKey && !e.altKey) {
            changeView('monthly');
        }
    }
    // H for historical view
    if (e.key === 'h' || e.key === 'H') {
        if (!e.ctrlKey && !e.altKey) {
            changeView('historical');
        }
    }
    // N for new transaction
    if (e.key === 'n' || e.key === 'N') {
        if (!e.ctrlKey && !e.altKey) {
            window.location.href = '/add-transaction';
        }
    }
});

// Initialize Charts
{% if chart_data.categories|length > 0 %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    
    // Datos del gráfico desde el backend
    const chartData = {
        categories: {{ chart_data.categories|tojson }},
        amounts: {{ chart_data.amounts|tojson }},
        colors: {{ chart_data.colors|tojson }}
    };
    
    // Crear gráfico de torta
    const categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.categories,
            datasets: [{
                data: chartData.amounts,
                backgroundColor: chartData.colors,
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 3,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // Ocultamos la leyenda del chart para usar nuestra leyenda personalizada
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = chartData.amounts.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 1000
            }
        }
    });
    
    // Generar leyenda personalizada
    generateCustomLegend(chartData);
});

function generateCustomLegend(chartData) {
    const legendContainer = document.getElementById('categoryLegend');
    const total = chartData.amounts.reduce((a, b) => a + b, 0);
    
    legendContainer.innerHTML = '';
    
    chartData.categories.forEach((category, index) => {
        const amount = chartData.amounts[index];
        const color = chartData.colors[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        
        const legendItem = document.createElement('div');
        legendItem.className = 'list-group-item d-flex justify-content-between align-items-center border-0 px-0 chart-legend-item';
        legendItem.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="chart-color-indicator" style="background-color: ${color};"></div>
                <span class="fw-medium">${category}</span>
            </div>
            <div class="text-end">
                <div class="fw-bold">$${amount.toLocaleString()}</div>
                <small class="text-muted">${percentage}%</small>
            </div>
        `;
        
        legendContainer.appendChild(legendItem);
    });
}
{% endif %}
</script>
{% endblock %}
